---
title: "Result"
author: "group2"
date: "2024-10-17"
output: 
  html_document:
    code_folding: hide
---
# Library

```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)      
library(readxl)    
library(janitor)   
library(stringr)   
library(tidyr)     
library(dplyr)
library(knitr)
library(ggplot2)
library(factoextra)
library(gt)
library(naniar)
library(ggcorrplot)
library(corrplot)
library(GGally)
library(randomForest)
library(pdp)
library(e1071)  
library(caret)
library(plotly)
library(stargazer)
library(broom)
library(kableExtra)
library(gridExtra)
library(patchwork)
library(minerva)
library(mgcv)
library(MASS)
library(glmnet)
```

# Data Import

```{r data import}
raw_bp <- read.csv(here("ZIPallFiles","AHSnpa11bp.csv"), header=TRUE)
raw_bb <- read.csv(here("ZIPallFiles","AHSnpa11bb.csv"), header=TRUE)
raw_bsp <- read.csv(here("ZIPallFiles","inp13bsp.csv"), header=TRUE)
raw_bcn <- read.csv(here("ZIPallFiles","inp13bcn.csv"), header=TRUE)
raw_bhh <- read.csv(here("ZIPallFiles","inp13bhh.csv"), header=TRUE)
```

# Rename and Created

```{r rename+Identity}
bp_bb <- inner_join(raw_bp, raw_bb, by = "ABSPID") %>%
  rename(HypertensionStatus = HYPBC,
         BodyMass = SABDYMS,
         SocialStatus = SF2SA1QN,
         PersonID = ABSPID,
         Age = AGEC,
         Gender = SEX,
         BMI = BMISC,
         Systolic = SYSTOL,
         Diastolic = DIASTOL,
         SmokeStatus = SMKSTAT,
         AlcoholPercentage_Day1 = ALCPER1,
         AlcoholPercentage_Day2 = ALCPER2,
         Potassium_Day1 = POTAST1,
         Potassium_Day2 = POTAST2,
         Sodium_Day1 = SODIUMT1,
         Sodium_Day2 = SODIUMT2,
         FiberEnergy_Day1 = FIBRPER1,
         FiberEnergy_Day2 = FIBRPER2,
         CarbohydrateEnergy_Day1 = CHOPER1,
         CarbohydrateEnergy_Day2 = CHOPER2,
         EnergyBMR_Day1 = EIBMR1,
         EnergyBMR_Day2 = EIBMR2) %>%
   mutate(Identity = factor(0))

bsp_bhh<- left_join(raw_bsp, raw_bhh,by = c("ABSHID")) %>%
  rename(BodyMass = SABDYMS,
         SocialStatus = SF2SA1DB,
         HouseID = ABSHID,
         Age = AGEEC,
         Gender = SEX,
         BMI = BMISC,
         Systolic = SYSTOL,
         Diastolic = DIASTOL,
         SmokeStatus = SMKSTAT,
         AlcoholPercentage_Day1 = ALCPER1,
         AlcoholPercentage_Day2 = ALCPER2,
         Potassium_Day1 = POTAST1,
         Potassium_Day2 = POTAST2,
         Sodium_Day1 = SODIUMT1,
         Sodium_Day2 = SODIUMT2,
         FiberEnergy_Day1 = FIBRPER1,
         FiberEnergy_Day2 = FIBRPER2,
         CarbohydrateEnergy_Day1 = CHOPER1,
         CarbohydrateEnergy_Day2 = CHOPER2,
         EnergyBMR_Day1 = EIBMR1,
         EnergyBMR_Day2 = EIBMR2)%>%
   mutate(Identity = factor(1))

bcn <- raw_bcn %>%
  rename(HouseID = ABSHID,
         MedicalCondition = ICD10ME)
```

# First Filter

```{r filter 1}
bp_bb <- bp_bb %>%
  mutate(EnergyBMR_Day1 = na_if(EnergyBMR_Day1, 997) %>% na_if(998),
         EnergyBMR_Day2 = na_if(EnergyBMR_Day2, 997) %>% na_if(998),
         EnergyBMR = (EnergyBMR_Day1 + EnergyBMR_Day2)/2) %>%
  filter(
    Age >= 18, 
    HypertensionStatus == 5,
    BodyMass != 4,
    (is.na(EnergyBMR) | EnergyBMR >= 0.9))

bsp_bhh <- bsp_bhh %>% 
  mutate(EnergyBMR_Day1 = na_if(EnergyBMR_Day1, 997) %>% na_if(998),
         EnergyBMR_Day2 = na_if(EnergyBMR_Day2, 997) %>% na_if(998),
         EnergyBMR = (EnergyBMR_Day1 + EnergyBMR_Day2)/2) %>%
  filter(
    Age >= 18, 
    BodyMass != 4,
    !HouseID %in% bcn$HouseID[bcn$MedicalCondition %in% c(7, 20)],
    (is.na(EnergyBMR) | EnergyBMR >= 0.9))
```

# Merge

```{r merge}
raw_data <- bind_rows(bp_bb,bsp_bhh)
```

# Variable Selection

```{r variable selection}
selected_data <- raw_data %>%
  dplyr::select(PersonID, HouseID, SocialStatus, Age, Gender, BMI, Systolic, Diastolic, SmokeStatus, Identity,
         AlcoholPercentage_Day1, AlcoholPercentage_Day2,
         Potassium_Day1, Potassium_Day2, Sodium_Day1, Sodium_Day2,
         FiberEnergy_Day1, FiberEnergy_Day2, 
         CarbohydrateEnergy_Day1, CarbohydrateEnergy_Day2)
```

# Type Check 1

```{r variable check before(Table1)}
data.frame(Variable = names(selected_data), Type = sapply(selected_data, class)) %>%
  gt() %>%
  tab_header(
    title = "Variable Names and Their Types"
  ) %>%
 tab_caption(caption = md("Table 1: Variable types table"))
```

# Na values + New Variables + Type Conversion

```{r navalue_new_typeconversion}
selected_data <- selected_data %>%
  mutate(
    across(c(Gender, SocialStatus, SmokeStatus), as.factor),
    BMI = na_if(BMI, 98) %>% na_if(99),
    Systolic = na_if(Systolic, 0) %>% na_if(998) %>% na_if(999),
    Diastolic = na_if(Diastolic, 0) %>% na_if(998) %>% na_if(999),
    Potassium = (Potassium_Day1 + Potassium_Day2) / 2, 
    Sodium = (Sodium_Day1 + Sodium_Day2) / 2,
    FiberEnergy = (FiberEnergy_Day1 + FiberEnergy_Day2)/2,
    CarbohydrateEnergy = (CarbohydrateEnergy_Day1 + CarbohydrateEnergy_Day2) / 2,
    AlcoholPercentage = (AlcoholPercentage_Day1 + AlcoholPercentage_Day2) /2,
    SodiumPotassiumRatio = Sodium / Potassium
    ) %>% 
  dplyr::select(PersonID,HouseID, SocialStatus, Age, Gender, BMI, Systolic, Diastolic, SmokeStatus, AlcoholPercentage, SodiumPotassiumRatio, FiberEnergy, CarbohydrateEnergy, Identity)
```

# Type Check 2

```{r variable check after(Table2)}
data.frame(Variable = names(selected_data), Type = sapply(selected_data, class)) %>%
  gt() %>%
  tab_header(
    title = "Variable Names and Their Types"
  ) %>%
 tab_caption(caption = md("Table 2: Variable types table after correction"))
```

# Duplicate Values

```{r duplicate values(Table3)}
selected_data %>% 
  dplyr::select(-PersonID) %>% 
  distinct() %>% 
  dim() %>% 
  tibble::tibble(Dimension = c("Rows", "Columns"), Count = .) %>% 
  gt() %>%
  tab_header(title = "Dimensions of Unique Tibble") %>%
  tab_caption(caption = md("Table 3: Dimensions of Unique Data Table"))
```

# Categrocial Distribution

```{r categrocial distribution bar plot(Figure1), warning=FALSE}
plot_categorical_distribution <- function(data) {
  categorical_vars <- data %>%
    dplyr::select(where(is.factor) | where(is.character)) %>%
    dplyr::select(-PersonID, -HouseID)
  
  for (var in names(categorical_vars)) {
    non_na_data <- data %>%
      filter(!is.na(.data[[var]]))
    if (nrow(non_na_data) == 0) next
    p <- ggplot(non_na_data, aes(x = .data[[var]])) +
      geom_bar(aes(y = (..count..) / sum(..count..), fill = .data[[var]]), color = "black") +
      scale_fill_brewer(palette = "Set3") + 
      labs(title = paste("Proportion of Categories in", var), x = "Category", y = "Proportion") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))  
    print(p)
    }
  }

plot_categorical_distribution(selected_data) 
```

# Merge Variable

```{r merge variable}
selected_data <- selected_data %>% 
  mutate(SmokeStatus = recode_factor(SmokeStatus, "2" = "1", "3" = "1","4" = "2","5" = "3"))
```

# Outliers and New Variables

```{r variable creation and outliers}
normal_ranges <- list(Systolic = c(90, 180), Diastolic = c(60, 120), BMI = c(16, 47.5), 
                      SodiumPotassiumRatio = c(0, 4), AlcoholPercentage = c(0, 85), 
                      CarbohydrateEnergy = c(0, 100), FiberEnergy = c(0, 100))

selected_data <- selected_data %>%
  filter(
    (is.na(Systolic) | (Systolic >= normal_ranges$Systolic[1] & Systolic <= normal_ranges$Systolic[2])),
    (is.na(Diastolic) | (Diastolic >= normal_ranges$Diastolic[1] & Diastolic <= normal_ranges$Diastolic[2])),
    (is.na(BMI) | (BMI >= normal_ranges$BMI[1] & BMI <= normal_ranges$BMI[2])),
    (is.na(AlcoholPercentage) | (AlcoholPercentage >= normal_ranges$AlcoholPercentage[1] & AlcoholPercentage <= normal_ranges$AlcoholPercentage[2])),
    (is.na(CarbohydrateEnergy) | (CarbohydrateEnergy >= normal_ranges$CarbohydrateEnergy[1] & CarbohydrateEnergy <= normal_ranges$CarbohydrateEnergy[2])),
    (is.na(FiberEnergy) | (FiberEnergy >= normal_ranges$FiberEnergy[1] & FiberEnergy <= normal_ranges$FiberEnergy[2])),
    (is.na(SodiumPotassiumRatio) | (SodiumPotassiumRatio >= normal_ranges$SodiumPotassiumRatio[1] & SodiumPotassiumRatio <= normal_ranges$SodiumPotassiumRatio[2]))
  ) %>%
  mutate(Hypertension = as.factor(case_when(Systolic >= 120 | Diastolic >= 80 ~ 1,TRUE ~ 0)))
```

# Variable check
```{r variable descriptions(Table4)}
variable_data <- data.frame(
  Variable = c("PersonID", "HouseID", "SocialStatus", "Age", "Gender", "BMI", 
               "Systolic", "Diastolic", "SmokeStatus", "AlcoholPercentage", 
               "SodiumPotassiumRatio", "FiberEnergy", "CarbohydrateEnergy", 
               "Identity"),
  Description = c("Selected person identifier", "Household identifier",
                  "ICD10 Conditions - Mini classification",
                  "Age of person", "Sex of person",
                  "Body Mass Index (BMI) - score measured",
                  "Systolic Blood Pressure (mmHg)",
                  "Diastolic Blood Pressure (mmHg)", "Smoking Status",
                  "Average of Percentage of energy from alcohol (Day1) and Percentage of energy from alcohol (Day2)",
                  "The ratio of the average of Sodium (supplement) Day 1 mg and Sodium (supplement) Day 2 mg over the average of Potassium (total) Day 1 mg and Potassium (total) Day 2 mg",
                  "Average of Percentage of energy from fibre (Day1) and Percentage of energy from fibre (Day2)",
                  "Average of Percentage of energy from carbohydrate (Day1) and Percentage of energy from carbohydrate (Day2)",
                  "Indicates whether the individual is part of the indigenous population"))

variable_table <- variable_data %>%
  gt() %>%
  tab_header(title = "All related variables") %>%
  cols_label(Variable = "Variable",Description = "Description") %>%
  tab_caption(caption = md("**Table 4:** Variable Descriptions"))%>%
  fmt_markdown(columns = everything()) %>%
  tab_options(table.width = pct(100))

variable_table
```

```{r predictor(Table5)}
selected_predictors <- selected_data %>%
  dplyr::select(FiberEnergy, CarbohydrateEnergy)

predictor_table <- data.frame(Variable = names(selected_predictors), Type = sapply(selected_predictors, class)) %>%
  gt() %>%
  tab_header(title = "Variable Names and Their Types") %>%
  tab_caption(caption = md("**Table 5**: Predictor variables and their data types"))

predictor_table
```

```{r confounding(Table6)}
confounding_vars <- selected_data %>%
  dplyr::select(-FiberEnergy, -CarbohydrateEnergy,-PersonID, -HouseID)

confounding_table <- data.frame(Variable = names(confounding_vars), Type = sapply(confounding_vars, class)) %>%
  gt() %>%
  tab_header(title = "Confounding Variables and Their Types") %>%
  tab_caption(caption = md("**Table 6**: Confounding variables and their data types"))

confounding_table
```

# Missing Values

```{r missing value(Table7), warning = FALSE}
selected_data %>% 
  dplyr::select(-PersonID, -HouseID) %>% 
  miss_var_summary() %>% 
  gt() %>%
  tab_header(title = "Missing Value") %>%
  tab_caption(caption = md("Table 7: Missing Values in Selected Data")) %>%
  cols_label(variable = "Variable Name", n_miss = "Missing Count", pct_miss = "Percentage Missing") %>%
  fmt_number(columns = everything(), decimals = 2)
```

```{r heat map(Figure2)}
corr_matrix <- selected_data%>%
  dplyr::select(where(is.numeric)) %>%
  mutate(across(everything(), ~ ifelse(is.na(.), mean(., na.rm = TRUE), .))) %>%
  cor(use = "complete.obs")

ggcorrplot(corr_matrix, lab = TRUE, 
           title = "Figure 2: Correlation Heatmap for ALL", 
           colors = c("blue", "white", "red"),
           tl.cex = 9, lab_size = 4) + theme(legend.position = "none")
```

# Regression Imputation

```{r regression imputation(Figure3), fig.height = 5, fig.width= 11}
selected_data$BMI[is.na(selected_data$BMI)] <- lm(BMI ~ Gender + SocialStatus + Age + SodiumPotassiumRatio + FiberEnergy + CarbohydrateEnergy + AlcoholPercentage + SmokeStatus + Identity, data = selected_data, na.action = na.exclude) %>% predict(newdata = selected_data[is.na(selected_data$BMI), ])

selected_data$Systolic[is.na(selected_data$Systolic)] <- lm(Systolic ~ Gender + SocialStatus + Age + BMI + SodiumPotassiumRatio + FiberEnergy + CarbohydrateEnergy + AlcoholPercentage + SmokeStatus + Identity, data = selected_data, na.action = na.exclude) %>% predict(newdata = selected_data[is.na(selected_data$Systolic), ])

selected_data$Diastolic[is.na(selected_data$Diastolic)] <- lm(Diastolic ~ Gender + SocialStatus + Age + BMI + Systolic + SodiumPotassiumRatio + FiberEnergy + CarbohydrateEnergy + AlcoholPercentage + SmokeStatus + Identity, data = selected_data, na.action = na.exclude) %>% predict(newdata = selected_data[is.na(selected_data$Diastolic), ])

vis_miss(selected_data %>% dplyr::select(-PersonID, -HouseID)) +
  ggtitle("Figure 3: Missing Data Visualization of Selected Variables")
```

# Normalization

```{r normalization}
numeric_data <- selected_data %>% dplyr::select_if(is.numeric)
preprocess_params <- preProcess(numeric_data, method = c("center", "scale"))
scaled_numeric_data <- predict(preprocess_params, numeric_data)
normalized_data <- bind_cols(scaled_numeric_data, selected_data %>% dplyr::select_if(Negate(is.numeric)))
```

# Multicollinearity

```{r multicollinearity matrix plot(Figure4), fig.height=10, fig.width=10}
selected_data %>%
  dplyr::select(where(is.numeric), -Systolic, -Diastolic) %>%
  ggscatmat() +
  ggtitle("Figure 4: Scatterplot Matrix of Selected Numeric Variables")
```


# Correlation

## Scatter plot

```{r scatter plot(Figure 5), warning=FALSE, message = FALSE, fig.width = 15}
fiber_syst_plot <- ggplot(selected_data, aes(x = FiberEnergy, y = Systolic)) +
  geom_point(color = "#FF7F0E", alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "#1F77B4", size = 1.5) +
  labs(title = "Figure 5.1: Fiber Energy vs Systolic", x = "Percentage of Energy from Fiber", y = "Systolic(mmHg)") +
  theme_light(base_size = 15) +
  theme(plot.title = element_text(hjust = 0.5))

fiber_dias_plot <- ggplot(selected_data, aes(x = FiberEnergy, y = Diastolic)) +
  geom_point(color = "#FF7F0E", alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "#1F77B4", size = 1.5) +
  labs(title = "Figure 5.2: Fiber Energy vs Diastolic", x = "Percentage of Energy from Fiber", y = "Diastolic(mmHg)") +
  theme_light(base_size = 15) +
  theme(plot.title = element_text(hjust = 0.5))

carbo_syst_plot <- ggplot(selected_data, aes(x = CarbohydrateEnergy, y = Systolic)) +
  geom_point(color = "#2CA02C", alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "#D62728", size = 1.5) +
  labs(title = "Figure 5.3: Carbohydrate Energy vs Systolic", x = "Percentage of Energy from Carbohydrate", y = "Systolic(mmHg)") +
  theme_light(base_size = 15) +
  theme(plot.title = element_text(hjust = 0.5))

carbo_dias_plot <- ggplot(selected_data, aes(x = CarbohydrateEnergy, y = Diastolic)) +
  geom_point(color = "#2CA02C", alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "#D62728", size = 1.5) +
  labs(title = "Figure 5.4: Carbohydrate Energy vs Diastolic", x = "Percentage of Energy from Carbohydrate", y = "Diastolic(mmHg)") +
  theme_light(base_size = 15) +
  theme(plot.title = element_text(hjust = 0.5))

grid.arrange(fiber_syst_plot, fiber_dias_plot, carbo_syst_plot, carbo_dias_plot, nrow = 2)
```

## Linear correlation table

```{r linar correlation table(Table8)}
fiber_syst_pearson <- cor(selected_data$FiberEnergy, selected_data$Systolic, method = "pearson")
fiber_syst_spearman <- cor(selected_data$FiberEnergy, selected_data$Systolic, method = "spearman")
fiber_dias_pearson <- cor(selected_data$FiberEnergy, selected_data$Diastolic, method = "pearson")
fiber_dias_spearman <- cor(selected_data$FiberEnergy, selected_data$Diastolic, method = "spearman")

carbo_syst_pearson <- cor(selected_data$CarbohydrateEnergy, selected_data$Systolic, method = "pearson")
carbo_syst_spearman <- cor(selected_data$CarbohydrateEnergy, selected_data$Systolic, method = "spearman")
carbo_dias_pearson <- cor(selected_data$CarbohydrateEnergy, selected_data$Diastolic, method = "pearson")
carbo_dias_spearman <- cor(selected_data$CarbohydrateEnergy, selected_data$Diastolic, method = "spearman")

correlation_table <- data.frame(
  Measure = c("FiberEnergy vs Systolic", "FiberEnergy vs Diastolic",
              "CarbohydrateEnergy vs Systolic", "CarbohydrateEnergy vs Diastolic"),
  Pearson_Correlation = c(fiber_syst_pearson, fiber_dias_pearson, carbo_syst_pearson, carbo_dias_pearson),
  Spearman_Correlation = c(fiber_syst_spearman, fiber_dias_spearman, carbo_syst_spearman, carbo_dias_spearman))

correlation_table %>%
  gt() %>%
  tab_header(
    title = "Table 8: Correlation Between Nutrient Energy Intake and Blood Pressure",
    subtitle = "Correlation values for both Systolic and Diastolic Blood Pressure") %>%
  fmt_number(columns = c(Pearson_Correlation, Spearman_Correlation), decimals = 2)
```

## Non-linear correlation table

```{r non-linear correlation table(Table9)}
fiber_syst_kendall <- cor(selected_data$FiberEnergy, selected_data$Systolic, method = "kendall")
fiber_syst_mic <- mine(selected_data$FiberEnergy, selected_data$Systolic)$MIC
fiber_dias_kendall <- cor(selected_data$FiberEnergy, selected_data$Diastolic, method = "kendall")
fiber_dias_mic <- mine(selected_data$FiberEnergy, selected_data$Diastolic)$MIC
carbo_syst_kendall <- cor(selected_data$CarbohydrateEnergy, selected_data$Systolic, method = "kendall")
carbo_syst_mic <- mine(selected_data$CarbohydrateEnergy, selected_data$Systolic)$MIC
carbo_dias_kendall <- cor(selected_data$CarbohydrateEnergy, selected_data$Diastolic, method = "kendall")
carbo_dias_mic <- mine(selected_data$CarbohydrateEnergy, selected_data$Diastolic)$MIC

correlation_table_mic_kendall <- data.frame(
  Measure = c("FiberEnergy vs Systolic", "FiberEnergy vs Diastolic",
              "CarbohydrateEnergy vs Systolic", "CarbohydrateEnergy vs Diastolic"),
  Kendall_Correlation = c(fiber_syst_kendall, fiber_dias_kendall, carbo_syst_kendall, carbo_dias_kendall),
  MIC_Correlation = c(fiber_syst_mic, fiber_dias_mic, carbo_syst_mic, carbo_dias_mic))

correlation_table_mic_kendall %>%
  gt() %>%
  tab_header(
    title = "Table 9: Kendall's Tau and MIC Correlation between Nutrient Energy Intake and Blood Pressure") %>%
  fmt_number(columns = c(Kendall_Correlation, MIC_Correlation), decimals = 3)
```

```{r Anova table(Table10)}
# Perform ANOVA tests
anova_fiber_systolic <- aov(Systolic ~ FiberEnergy, data = selected_data)
anova_fiber_diastolic <- aov(Diastolic ~ FiberEnergy, data = selected_data)
anova_carb_systolic <- aov(Systolic ~ CarbohydrateEnergy, data = selected_data)
anova_carb_diastolic <- aov(Diastolic ~ CarbohydrateEnergy, data = selected_data)

# Create a table summarizing F-statistic and p-value
anova_table <- data.frame(
  Measure = c("FiberEnergy vs Systolic", "FiberEnergy vs Diastolic", 
              "CarbohydrateEnergy vs Systolic", "CarbohydrateEnergy vs Diastolic"),
  F_Statistic = c(
    summary(anova_fiber_systolic)[[1]]$`F value`[1], 
    summary(anova_fiber_diastolic)[[1]]$`F value`[1], 
    summary(anova_carb_systolic)[[1]]$`F value`[1], 
    summary(anova_carb_diastolic)[[1]]$`F value`[1]
  ),
  P_Value = c(
    summary(anova_fiber_systolic)[[1]]$`Pr(>F)`[1], 
    summary(anova_fiber_diastolic)[[1]]$`Pr(>F)`[1], 
    summary(anova_carb_systolic)[[1]]$`Pr(>F)`[1], 
    summary(anova_carb_diastolic)[[1]]$`Pr(>F)`[1]
  )
)

# Build the table with gt
anova_table %>%
  gt() %>%
  tab_header(
    title = "ANOVA Test Results: Nutrient Energy Intake vs Blood Pressure"
  ) %>%
  fmt_number(columns = c(F_Statistic, P_Value), decimals = 3)
```

# Model comparison

GAM
Multiple Linear regression
Robust
Polynomial regression
Lasso regression

## Systolic
```{r model comparision metric[Systolic]}
set.seed(3888)
k <- 5
repeats <- 3

gam_rmse_systolic <- numeric()
gam_mae_systolic <- numeric()
gam_r2_systolic <- numeric()

mlr_rmse_systolic <- numeric()
mlr_mae_systolic <- numeric()
mlr_r2_systolic <- numeric()

robust_rmse_systolic <- numeric()
robust_mae_systolic <- numeric()
robust_r2_systolic <- numeric()

poly_rmse_systolic <- numeric()
poly_mae_systolic <- numeric()
poly_r2_systolic <- numeric()

lasso_rmse_systolic <- numeric()
lasso_mae_systolic <- numeric()
lasso_r2_systolic <- numeric()

n <- nrow(normalized_data)

for (r in 1:repeats) {
  folds <- sample(rep(1:k, length.out = n))
  
  for (i in 1:k) {
    train_idx <- which(folds != i)
    test_idx <- which(folds == i)
    
    data_train <- normalized_data[train_idx, ]
    data_test <- normalized_data[test_idx, ]
    
    actual <- data_test$Systolic
    #GAM
    gam_model <- gam(Systolic ~ s(Age) + s(BMI) + SocialStatus + Gender + SmokeStatus +
                       s(AlcoholPercentage) + s(FiberEnergy) + s(CarbohydrateEnergy) + 
                       Identity + s(SodiumPotassiumRatio),
                     data = data_train)
    
    gam_predictions <- predict(gam_model, newdata = data_test)
    
    gam_rmse <- sqrt(mean((gam_predictions - actual)^2))
    gam_mae <- mean(abs(gam_predictions - actual))
    gam_r2 <- cor(gam_predictions, actual)^2
    
    gam_rmse_systolic <- c(gam_rmse_systolic, gam_rmse)
    gam_mae_systolic <- c(gam_mae_systolic, gam_mae)
    gam_r2_systolic <- c(gam_r2_systolic, gam_r2)
    #Multiple Linear Regression
    mlr_model <- lm(Systolic ~ Age + BMI + SocialStatus + Gender + SmokeStatus +
                      AlcoholPercentage + FiberEnergy + CarbohydrateEnergy + 
                      Identity + SodiumPotassiumRatio, data = data_train)
    
    mlr_predictions <- predict(mlr_model, newdata = data_test)
    
    mlr_rmse <- sqrt(mean((mlr_predictions - actual)^2))
    mlr_mae <- mean(abs(mlr_predictions - actual))
    mlr_r2 <- cor(mlr_predictions, actual)^2
    
    mlr_rmse_systolic <- c(mlr_rmse_systolic, mlr_rmse)
    mlr_mae_systolic <- c(mlr_mae_systolic, mlr_mae)
    mlr_r2_systolic <- c(mlr_r2_systolic, mlr_r2)
    #Robust Regression
    robust_model <- rlm(Systolic ~ Age + BMI + SocialStatus + Gender + SmokeStatus +
                          AlcoholPercentage + FiberEnergy + CarbohydrateEnergy + 
                          Identity + SodiumPotassiumRatio, data = data_train)
    
    robust_predictions <- predict(robust_model, newdata = data_test)
    
    robust_rmse <- sqrt(mean((robust_predictions - actual)^2))
    robust_mae <- mean(abs(robust_predictions - actual))
    robust_r2 <- cor(robust_predictions, actual)^2
    
    robust_rmse_systolic <- c(robust_rmse_systolic, robust_rmse)
    robust_mae_systolic <- c(robust_mae_systolic, robust_mae)
    robust_r2_systolic <- c(robust_r2_systolic, robust_r2)
    #Polynomial Regression
    poly_model <- lm(Systolic ~ poly(Age, 2) + poly(BMI, 2) + SocialStatus + Gender + SmokeStatus +
                       poly(AlcoholPercentage, 2) + poly(FiberEnergy, 2) + poly(CarbohydrateEnergy, 2) + 
                       Identity + poly(SodiumPotassiumRatio, 2),
                     data = data_train)
    
    poly_predictions <- predict(poly_model, newdata = data_test)
    
    poly_rmse <- sqrt(mean((poly_predictions - actual)^2))
    poly_mae <- mean(abs(poly_predictions - actual))
    poly_r2 <- cor(poly_predictions, actual)^2
    
    poly_rmse_systolic <- c(poly_rmse_systolic, poly_rmse)
    poly_mae_systolic <- c(poly_mae_systolic, poly_mae)
    poly_r2_systolic <- c(poly_r2_systolic, poly_r2)
    #Lasso Regression
    x_train <- model.matrix(Systolic ~ Age + BMI + SocialStatus + Gender + SmokeStatus +
                              AlcoholPercentage + FiberEnergy + CarbohydrateEnergy + 
                              Identity + SodiumPotassiumRatio, data = data_train)[, -1]
    y_train <- data_train$Systolic
    x_test <- model.matrix(Systolic ~ Age + BMI + SocialStatus + Gender + SmokeStatus +
                             AlcoholPercentage + FiberEnergy + CarbohydrateEnergy + 
                             Identity + SodiumPotassiumRatio, data = data_test)[, -1]
  
    lasso_model <- cv.glmnet(x_train, y_train, alpha = 1)
  
    lasso_predictions <- predict(lasso_model, s = lasso_model$lambda.min, newx = x_test)
    
    lasso_rmse <- sqrt(mean((lasso_predictions - actual)^2))
    lasso_mae <- mean(abs(lasso_predictions - actual))
    lasso_r2 <- cor(lasso_predictions, actual)^2
    
    lasso_rmse_systolic <- c(lasso_rmse_systolic, lasso_rmse)
    lasso_mae_systolic <- c(lasso_mae_systolic, lasso_mae)
    lasso_r2_systolic <- c(lasso_r2_systolic, lasso_r2)
  }
}

mean_systolic_gam_rmse <- mean(gam_rmse_systolic)
mean_systolic_gam_mae <- mean(gam_mae_systolic)
mean_systolic_gam_r2 <- mean(gam_r2_systolic)

mean_systolic_mlr_rmse <- mean(mlr_rmse_systolic)
mean_systolic_mlr_mae <- mean(mlr_mae_systolic)
mean_systolic_mlr_r2 <- mean(mlr_r2_systolic)

mean_systolic_robust_rmse <- mean(robust_rmse_systolic)
mean_systolic_robust_mae <- mean(robust_mae_systolic)
mean_systolic_robust_r2 <- mean(robust_r2_systolic)

mean_systolic_poly_rmse <- mean(poly_rmse_systolic)
mean_systolic_poly_mae <- mean(poly_mae_systolic)
mean_systolic_poly_r2 <- mean(poly_r2_systolic)

mean_systolic_lasso_rmse <- mean(lasso_rmse_systolic)
mean_systolic_lasso_mae <- mean(lasso_mae_systolic)
mean_systolic_lasso_r2 <- mean(lasso_r2_systolic)
```

```{r model performance[Systolic](Figure6), fig.width=10}
Systolic_df <- data.frame(
    Model = c("GAM", "Polynomial", "Robust" ,"Multiple Linear", "Lasso"),
    RMSE = c(mean_systolic_gam_rmse, mean_systolic_poly_rmse, mean_systolic_robust_rmse,mean_systolic_mlr_rmse, mean_systolic_lasso_rmse),
    MAE = c(mean_systolic_gam_mae, mean_systolic_poly_mae, mean_systolic_robust_mae, mean_systolic_mlr_mae, mean_systolic_lasso_mae),
    R2 = c(mean_systolic_gam_r2, mean_systolic_poly_r2, mean_systolic_robust_r2, mean_systolic_mlr_r2, mean_systolic_lasso_r2)
)

# Define custom colors for the bar plots
colors <- c('#F8766D', '#A3A500', '#E76BF3','#00B0F6', '#00BF7D')

rmse_range <- c(min(Systolic_df$RMSE) * 0.95, max(Systolic_df$RMSE) * 1.05)
mae_range <- c(min(Systolic_df$MAE) * 0.95, max(Systolic_df$MAE) * 1.05)
r2_range <- c(min(Systolic_df$R2) * 0.95, max(Systolic_df$R2) * 1.05)

Systolic_rmse <- plot_ly(Systolic_df, x = ~Model, y = ~round(RMSE, 3), type = 'bar', color = ~Model, colors = colors,
               text = ~round(RMSE, 3), textposition = 'outside', textfont = list(color = 'black')) %>%
  layout(
    yaxis = list(title = 'RMSE', range = rmse_range),
    showlegend = FALSE,
    paper_bgcolor = 'rgba(245, 246, 249, 1)',
    plot_bgcolor = 'rgba(0, 0, 0, 0)')

Systolic_mae <- plot_ly(Systolic_df, x = ~Model, y = ~round(MAE, 3), type = 'bar', color = ~Model, colors = colors,
               text = ~round(MAE, 3), textposition = 'outside', textfont = list(color = 'black')) %>%
  layout(
    yaxis = list(title = 'MAE', range = mae_range),
    showlegend = FALSE,
    paper_bgcolor = 'rgba(245, 246, 249, 1)',
    plot_bgcolor = 'rgba(0, 0, 0, 0)')

Systolic_r2 <- plot_ly(Systolic_df, x = ~Model, y = ~round(R2, 3), type = 'bar', color = ~Model, colors = colors,
               text = ~round(R2, 3), textposition = 'outside', textfont = list(color = 'black')) %>%
  layout(
    yaxis = list(title = 'R²', range = r2_range),
    showlegend = FALSE,
    paper_bgcolor = 'rgba(245, 246, 249, 1)',
    plot_bgcolor = 'rgba(0, 0, 0, 0)')

SystolicFig <- subplot(Systolic_rmse, Systolic_mae, Systolic_r2, nrows = 1, shareY = FALSE, titleX = TRUE) %>%
  layout(title = list(text = "Figure6.1: RMSE Comparison(Systolic)[Left], Figure 6.2: MAE Comparison(Systolic)[Middle], Figure 6.3: R² Comparison(Systolic)[Right]", 
                      font = list(size = 12)))

SystolicFig
```
## Diastolic
```{r model comparision metric[Diastolic]}
set.seed(3888)
gam_rmse_diastolic <- numeric()
gam_mae_diastolic <- numeric()
gam_r2_diastolic <- numeric()

mlr_rmse_diastolic <- numeric()
mlr_mae_diastolic <- numeric()
mlr_r2_diastolic <- numeric()

robust_rmse_diastolic <- numeric()
robust_mae_diastolic <- numeric()
robust_r2_diastolic <- numeric()

poly_rmse_diastolic <- numeric()
poly_mae_diastolic <- numeric()
poly_r2_diastolic <- numeric()

lasso_rmse_diastolic <- numeric()
lasso_mae_diastolic <- numeric()
lasso_r2_diastolic <- numeric()

for (r in 1:repeats) {
  folds <- sample(rep(1:k, length.out = n))
  
  for (i in 1:k) {
    train_idx <- which(folds != i)
    test_idx <- which(folds == i)
    data_train <- normalized_data[train_idx, ]
    data_test <- normalized_data[test_idx, ]
    
    actual <- data_test$Diastolic
    #GAM
    gam_model <- gam(Diastolic ~ s(Age) + s(BMI) + SocialStatus + Gender + SmokeStatus +
                       s(AlcoholPercentage) + s(FiberEnergy) + s(CarbohydrateEnergy) + 
                       Identity + s(SodiumPotassiumRatio),
                     data = data_train)
    
    gam_predictions <- predict(gam_model, newdata = data_test)
    
    gam_rmse <- sqrt(mean((gam_predictions - actual)^2))
    gam_mae <- mean(abs(gam_predictions - actual))
    gam_r2 <- cor(gam_predictions, actual)^2
    
    gam_rmse_diastolic <- c(gam_rmse_diastolic, gam_rmse)
    gam_mae_diastolic <- c(gam_mae_diastolic, gam_mae)
    gam_r2_diastolic <- c(gam_r2_diastolic, gam_r2)
    #Multiple Linear Regression
    mlr_model <- lm(Diastolic ~ Age + BMI + SocialStatus + Gender + SmokeStatus +
                      AlcoholPercentage + FiberEnergy + CarbohydrateEnergy + 
                      Identity + SodiumPotassiumRatio, data = data_train)
    
    mlr_predictions <- predict(mlr_model, newdata = data_test)
    
    mlr_rmse <- sqrt(mean((mlr_predictions - actual)^2))
    mlr_mae <- mean(abs(mlr_predictions - actual))
    mlr_r2 <- cor(mlr_predictions, actual)^2
    
    mlr_rmse_diastolic <- c(mlr_rmse_diastolic, mlr_rmse)
    mlr_mae_diastolic <- c(mlr_mae_diastolic, mlr_mae)
    mlr_r2_diastolic <- c(mlr_r2_diastolic, mlr_r2)
    #Robust Regression
    robust_model <- rlm(Diastolic ~ Age + BMI + SocialStatus + Gender + SmokeStatus +
                          AlcoholPercentage + FiberEnergy + CarbohydrateEnergy + 
                          Identity + SodiumPotassiumRatio, data = data_train)
    
    robust_predictions <- predict(robust_model, newdata = data_test)
    
    robust_rmse <- sqrt(mean((robust_predictions - actual)^2))
    robust_mae <- mean(abs(robust_predictions - actual))
    robust_r2 <- cor(robust_predictions, actual)^2
    
    robust_rmse_diastolic <- c(robust_rmse_diastolic, robust_rmse)
    robust_mae_diastolic <- c(robust_mae_diastolic, robust_mae)
    robust_r2_diastolic <- c(robust_r2_diastolic, robust_r2)
    #Polynomial Regression
    poly_model <- lm(Diastolic ~ poly(Age, 2) + poly(BMI, 2) + SocialStatus + Gender + SmokeStatus +
                       poly(AlcoholPercentage, 2) + poly(FiberEnergy, 2) + poly(CarbohydrateEnergy, 2) + 
                       Identity + poly(SodiumPotassiumRatio, 2),
                     data = data_train)
    
    poly_predictions <- predict(poly_model, newdata = data_test)
    
    poly_rmse <- sqrt(mean((poly_predictions - actual)^2))
    poly_mae <- mean(abs(poly_predictions - actual))
    poly_r2 <- cor(poly_predictions, actual)^2
    
    poly_rmse_diastolic <- c(poly_rmse_diastolic, poly_rmse)
    poly_mae_diastolic <- c(poly_mae_diastolic, poly_mae)
    poly_r2_diastolic <- c(poly_r2_diastolic, poly_r2)
    #Lasso Regression
    x_train <- model.matrix(Diastolic ~ Age + BMI + SocialStatus + Gender + SmokeStatus +
                              AlcoholPercentage + FiberEnergy + CarbohydrateEnergy + 
                              Identity + SodiumPotassiumRatio, data = data_train)[, -1]
    y_train <- data_train$Diastolic
    x_test <- model.matrix(Diastolic ~ Age + BMI + SocialStatus + Gender + SmokeStatus +
                             AlcoholPercentage + FiberEnergy + CarbohydrateEnergy + 
                             Identity + SodiumPotassiumRatio, data = data_test)[, -1]
  
    lasso_model <- cv.glmnet(x_train, y_train, alpha = 1)
  
    lasso_predictions <- predict(lasso_model, s = lasso_model$lambda.min, newx = x_test)
    
    lasso_rmse <- sqrt(mean((lasso_predictions - actual)^2))
    lasso_mae <- mean(abs(lasso_predictions - actual))
    lasso_r2 <- cor(lasso_predictions, actual)^2
    
    lasso_rmse_diastolic <- c(lasso_rmse_diastolic, lasso_rmse)
    lasso_mae_diastolic <- c(lasso_mae_diastolic, lasso_mae)
    lasso_r2_diastolic <- c(lasso_r2_diastolic, lasso_r2)
  }
}

mean_diastolic_gam_rmse <- mean(gam_rmse_diastolic)
mean_diastolic_gam_mae <- mean(gam_mae_diastolic)
mean_diastolic_gam_r2 <- mean(gam_r2_diastolic)

mean_diastolic_mlr_rmse <- mean(mlr_rmse_diastolic)
mean_diastolic_mlr_mae <- mean(mlr_mae_diastolic)
mean_diastolic_mlr_r2 <- mean(mlr_r2_diastolic)

mean_diastolic_robust_rmse <- mean(robust_rmse_diastolic)
mean_diastolic_robust_mae <- mean(robust_mae_diastolic)
mean_diastolic_robust_r2 <- mean(robust_r2_diastolic)

mean_diastolic_poly_rmse <- mean(poly_rmse_diastolic)
mean_diastolic_poly_mae <- mean(poly_mae_diastolic)
mean_diastolic_poly_r2 <- mean(poly_r2_diastolic)

mean_diastolic_lasso_rmse <- mean(lasso_rmse_diastolic)
mean_diastolic_lasso_mae <- mean(lasso_mae_diastolic)
mean_diastolic_lasso_r2 <- mean(lasso_r2_diastolic)
```

```{r model performance[Diastolic](Figure6),fig.width=10}
Diastolic_df <- data.frame(
    Model = c("GAM", "Polynomial", "Robust" ,"Multiple Linear", "Lasso"),
    RMSE = c(mean_diastolic_gam_rmse, mean_diastolic_poly_rmse, mean_diastolic_robust_rmse,mean_diastolic_mlr_rmse, mean_diastolic_lasso_rmse),
    MAE = c(mean_diastolic_gam_mae, mean_diastolic_poly_mae, mean_diastolic_robust_mae, mean_diastolic_mlr_mae, mean_diastolic_lasso_mae),
    R2 = c(mean_diastolic_gam_r2, mean_diastolic_poly_r2, mean_diastolic_robust_r2, mean_diastolic_mlr_r2, mean_diastolic_lasso_r2)
)

colors <- c('#F8766D', '#A3A500', '#E76BF3','#00B0F6', '#00BF7D')

rmse_range <- c(min(Diastolic_df$RMSE) * 0.95, max(Diastolic_df$RMSE) * 1.05)
mae_range <- c(min(Diastolic_df$MAE) * 0.95, max(Diastolic_df$MAE) * 1.05)
r2_range <- c(min(Diastolic_df$R2) * 0.95, max(Diastolic_df$R2) * 1.05)

Diastolic_rmse <- plot_ly(Diastolic_df, x = ~Model, y = ~round(RMSE, 3), type = 'bar', color = ~Model, colors = colors,
               text = ~round(RMSE, 3), textposition = 'outside', textfont = list(color = 'black')) %>%
  layout(
    yaxis = list(title = 'RMSE', range = rmse_range),
    showlegend = FALSE,
    paper_bgcolor = 'rgba(245, 246, 249, 1)',
    plot_bgcolor = 'rgba(0, 0, 0, 0)')

Diastolic_mae <- plot_ly(Diastolic_df, x = ~Model, y = ~round(MAE, 3), type = 'bar', color = ~Model, colors = colors,
               text = ~round(MAE, 3), textposition = 'outside', textfont = list(color = 'black')) %>%
  layout(
    yaxis = list(title = 'MAE', range = mae_range),
    showlegend = FALSE,
    paper_bgcolor = 'rgba(245, 246, 249, 1)',
    plot_bgcolor = 'rgba(0, 0, 0, 0)')

Diastolic_r2 <- plot_ly(Diastolic_df, x = ~Model, y = ~round(R2, 3), type = 'bar', color = ~Model, colors = colors,
               text = ~round(R2, 3), textposition = 'outside', textfont = list(color = 'black')) %>%
  layout(
    yaxis = list(title = 'R²', range = r2_range),
    showlegend = FALSE,
    paper_bgcolor = 'rgba(245, 246, 249, 1)',
    plot_bgcolor = 'rgba(0, 0, 0, 0)')

DiastolicFig <- subplot(
  Diastolic_rmse, 
  Diastolic_mae, 
  Diastolic_r2, 
  nrows = 1, 
  shareY = FALSE
) %>%
  layout(title = list(text = "Figure 6.4: RMSE Comparison (Diastolic)[Left], Figure 6.5: MAE Comparison (Diastolic)[Middle], Figure 6.6: R² Comparison (Diastolic)[Right]", 
                      font = list(size = 12)))

DiastolicFig
```
